name: Extend Server Time

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    # ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªæ—¶é—´
    - cron: '0 */6 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘ workflow

jobs:
  run-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      secrets: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install playwright requests PyNaCl
          playwright install chromium

      - name: Run Python script
        env:
          REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
          LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python main.py

      - name: Update REMEMBER_WEB_COOKIE secret
        if: success() && hashFiles('updated_cookies.txt') != ''
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python3 -c '
          import os
          import requests
          import base64
          from nacl import encoding, public

          if os.path.exists("updated_cookies.txt"):
              with open("updated_cookies.txt", "r") as f:
                  secret_value = f.read().strip()

              if secret_value:
                  print("æ£€æµ‹åˆ°æ–°çš„ cookiesï¼Œæ­£åœ¨æ›´æ–° GitHub secret...")
                  secret_name = "REMEMBER_WEB_COOKIE"
                  gh_pat = os.environ["GH_PAT"]
                  repo = os.environ["GITHUB_REPOSITORY"]

                  try:
                      # è·å– public key
                      url = f"https://api.github.com/repos/{repo}/actions/secrets/public-key"
                      headers = {"Authorization": f"token {gh_pat}"}
                      response = requests.get(url, headers=headers, timeout=30)

                      if response.status_code == 200:
                          key_data = response.json()
                          key_id = key_data["key_id"]
                          public_key_b64 = key_data["key"]

                          # ä½¿ç”¨ libsodium åŠ å¯† secret
                          public_key_obj = public.PublicKey(public_key_b64.encode("utf-8"), encoding.Base64Encoder)
                          sealed_box = public.SealedBox(public_key_obj)
                          encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
                          encrypted_value = base64.b64encode(encrypted).decode("utf-8")

                          # æ›´æ–° secret
                          url = f"https://api.github.com/repos/{repo}/actions/secrets/{secret_name}"
                          data = {
                              "encrypted_value": encrypted_value,
                              "key_id": key_id
                          }
                          response = requests.put(url, headers=headers, json=data, timeout=30)

                          if response.status_code in [201, 204]:
                              print("âœ… æˆåŠŸæ›´æ–° REMEMBER_WEB_COOKIE secret")
                              os.remove("updated_cookies.txt")
                          else:
                              print(f"âŒ æ›´æ–° secret å¤±è´¥: {response.status_code}")
                      else:
                          print(f"âŒ è·å– public key å¤±è´¥: {response.status_code}")
                  except Exception as e:
                      print(f"âŒ æ›´æ–°è¿‡ç¨‹ä¸­å‡ºé”™: {e}")
          '

      - name: Upload screenshots
        if: always() # ä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¸Šä¼ æˆªå›¾
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: |
            *.png

      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ ! -f time.txt ]; then
            echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi

          git add time.txt
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ•’ æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi
